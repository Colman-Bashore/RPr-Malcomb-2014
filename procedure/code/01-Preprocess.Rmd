---
output: html_document
---

# Data Acquisition for Malcomb et al (2014)

Malcomb, D. W., E. A. Weaver, and A. R. Krakowka. 2014. Vulnerability modeling for sub-Saharan Africa: An operationalized approach in Malawi. Applied Geography 48:17-30. [https://doi.org/10.1016/j.apgeog.2014.01.004](%5Bhttps://doi.org/10.1016/j.apgeog.2014.01.004)

**Script Authors**: Drew An-Pham & Joseph Holler

## Computational Environment

Install and load packages

```{r libraries, include = F}
packages <- c("downloader", "here", "rdhs")
setdiff(packages, rownames(installed.packages()))
install.packages(setdiff(packages, rownames(installed.packages())), quietly = TRUE)

library(downloader)
library(here)
library(rdhs)
```

Set up file paths

```{r file paths}
# these values allow you to access private and public raw data more efficiently
private_r <- here("data", "raw", "private")
public_r <- here("data", "raw", "public")
scratch <- here("data", "scratch")
```

## Download Data

If the traditional authorities data `MWI_adm2.shp` are not already in the 
`data/raw/private` directory, then download from GADM version 2.8 at
https://gadm.org/download_country_v2.html and unzip.
This data must be downloaded because the GADM license does not permit
redistribution, and no one responded to a request to do so.

```{r download traditional authorities}
if (!"MWI_adm2.shp" %in% list.files(private_r)) {
  download(
    "https://biogeo.ucdavis.edu/data/gadm2.8/shp/MWI_adm_shp.zip",
    here(scratch, "MWI_adm_shp.zip")
  )

  # list all the second administrative level (traditional authority) files
  # (code developed before GADM started offering more useful file types)
  MWI_adm_files <- unzip(here(scratch, "MWI_adm_shp.zip"), list = TRUE)
  MWI_adm_files <- MWI_adm_files[grep("adm2", MWI_adm_files$Name), "Name"]

  # unzip the second administrative level (traditional authority)
  unzip(here(scratch, "MWI_adm_shp.zip"),
    exdir = private_r,
    files = MWI_adm_files
  )
  rm(MWI_adm_files)
} else {
  print("Traditional authorites data already downloaded.")
}
```

If livelihood zones data `MW_LHZ_2009.shp` are not already in the 
`data/raw/public` directory, then download livelihood zones from FEWS NET Data 
Center at https://fews.net/fews-data/335 and unzip.

```{r download livelihood zones}
if (!"MW_LHZ_2009.shp" %in% list.files(public_r)) {
  download(
    "https://fews.net/data_portal_download/download?data_file_path=http%3A//shapefiles.fews.net.s3.amazonaws.com/LHZ/MW_LHZ_2009.zip",
    here(scratch, "MW_LHZ_2009.zip")
  )
  unzip(here(scratch, "MW_LHZ_2009.zip"), exdir = public_r)
} else {
  print("Livelihood zones data already downloaded.")
}
```

### Lakes

If major lakes data `major_lakes.csv` are not already in the `data/raw/public` directory, then download major lakes from MASDAP and unzip.

```{r download lakes}
if (!"major_lakes.csv" %in% list.files(public_r)) {
  # major lakes in malawi: http://www.masdap.mw/
  download(
    "http://www.masdap.mw/geoserver/ows?outputFormat=csv&service=WFS&srs=EPSG%3A4326&request=GetFeature&typename=geonode%3Amajor_lakes&version=1.0.0",
    here(public_r, "major_lakes.csv")
  )
} else {
  print("Lakes data already downloaded.")
}
```

### Flood and Drought Exposure

The UNEP Global Risk Data Platform used for this research is no longer available online. The data is provided with the research compendium.

### Demographic and Health Survey (DHS)

#### Access

Geographic USAID Demographic and Health Survey (DHS) data requires pre-approved access clearance and login credentials from the DHS Program. You may gain access using the instructions below. Note that the project title and description of study may be altered, and the example title and descriptions were used for this reproduction study.

1.  Go to <https://dhsprogram.com/Data/>
2.  Create an account, ideally with an education or government e-mail address
3.  Within the Datasets menu, [Create a new project](https://dhsprogram.com/data/dataset_admin/index.cfm?action=createproject)
4.  Enter the following information: **Project Title:** Reproducing a Vulnerability Model of Malawi **Description of Study:** The purpose of this study is to reproduce the methods of a published research article: Malcomb, D. W., E. A. Weaver, and A. R. Krakowka. 2014. Vulnerability modeling for sub-Saharan Africa: An operationalized approach in Malawi. Applied Geography 48:17--30. [DOI:[10.1016/j.apgeog.2014.01.004](DOI:%5B10.1016/j.apgeog.2014.01.004){.uri}](<http://dx.doi.org/10.1016/j.apgeog.2014.01.004>){.uri}. The authors of this paper used geocoded DHS surveys for Malawi in 2004 and 2010, in combination with FEWSnet livelihood data and UNEP flood and drought risk data. Following the author's methodology, we plan to download the data using the rdhs package for R and aggregate the data at Malawi's 2nd administrative level: districts. We will be working with a GitHub repository that stores the raw data locally in a directory ignored by the .gitignore file, and only moves the data into a shared and version-controlled directory once it has been aggregated to the District level. This will ensure that the privacy of survey respondents and requirements of data partners are protected, because all of the data will be aggregated into district polygons, as already shown and published in Malcomb et al (2014).
5.  Choose Region: Sub-Saharan Africa
6.  Click **Show GPS Datasets** at the top-left of the country tables
7.  Check **Survey** and **GPS** data for **Malawi**
8.  Save selection
9.  Read and agree to the conditions of use for the DHS Program datasets and save these conditions for your metadata records.
10. Enter a **Justification for using DHS Program Geographic Datasets:** The research aim is to reproduce Malcomb et al (2014) in which GPS Datasets are used to spatially join DHS Survey data to Malawi's Districts for the purpose of sub-national climate change vulnerability mapping. Therefore, the research will not be reproducible without the geographic datasets.

#### Download

The following code will prompt you for your DHS Data account login email and project name in the console. These are saved in the scratch folder. The `rdhs` package will then prompt you with a dialogue pop-up for your password.

```{r dhs data access configuration}
# ask user for login email and project name
email <- readline(prompt = "Enter DHS Login Email: ")
project <- readline(prompt = "Enter Project Name: ")
rdhs_json <- here(scratch, "rdhs.json")

if (!file.exists(rdhs_json)) file.create(rdhs_json)

# running this function will prompt you to enter email and project information in the Console and password in a popup
set_rdhs_config(
  email = email,
  project = project,
  config_path = rdhs_json,
  global = FALSE,
  cache_path = here(private_r)
)
```

Download the Malawi 2010 survey data and geographic points.

```{r downloading dhs data}
dhs_downloads <- get_datasets(
  c("MWHR61SV", "MWGE62FL"),
  all_lower = FALSE,
  download_option = "rds"
)
# If data has already been downloaded, this throws an error:
# 'names' attribute [1] must be the same length as the vector [0]
```
